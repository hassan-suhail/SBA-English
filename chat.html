<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Page</title>
</head>
<body>
    <h2>Chat</h2>

    <!-- Chat box where messages will appear -->
    <div id="chat-box" style="border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px;">
        <!-- Messages will be appended here -->
    </div>

    <!-- Input field to type new messages -->
    <input type="text" id="chat-input" placeholder="Type a message..." style="width: 80%;">
    <button onclick="sendMessage()">Send</button>

    <!-- Load the Google API client library -->
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        let auth2Client;
        const SHEET_ID = '452875508182-oh59nv1r45bbapn77o7iqmp688levf97.apps.googleusercontent.com'; // Replace with your OAuth client ID
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        async function initializeClient() {
            return new Promise((resolve, reject) => {
                gapi.load('client:auth2', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: 'AIzaSyBPqIF_BJstzy0W2gVJr52wG6f3HQS2-kQ',   // Optional: this can be removed if only using OAuth
                            clientId: CLIENT_ID,
                            scope: SCOPES
                        });
                        auth2Client = gapi.auth2.getAuthInstance();
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        }

        async function authenticate() {
            if (!auth2Client.isSignedIn.get()) {
                await auth2Client.signIn();
            }
        }

        async function sendMessage() {
            const message = document.getElementById("chat-input").value;
            if (!message) return;

            const now = new Date().toISOString();

            try {
                await authenticate(); // Ensure the user is signed in
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SHEET_ID,
                    range: 'Sheet1!A:B',
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [[now, message]]
                    }
                });

                document.getElementById("chat-input").value = ''; // Clear the input field
                loadMessages(); // Reload messages
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message. Please check your credentials and try again.");
            }
        }

        async function loadMessages() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SHEET_ID,
                    range: 'Sheet1!A:B'
                });

                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = ''; // Clear the chat box

                const rows = response.result.values;
                if (rows && rows.length > 0) {
                    rows.forEach(row => {
                        const timestamp = row[0];
                        const message = row[1];
                        const messageElement = document.createElement('div');
                        messageElement.textContent = `${timestamp}: ${message}`;
                        chatBox.appendChild(messageElement);
                    });
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } catch (error) {
                console.error("Error loading messages:", error);
                alert("Failed to load messages. Please check your credentials and try again.");
            }
        }

        async function init() {
            await initializeClient();
            await loadMessages();
        }

        // Initialize the Google API client and load messages on page load
        window.onload = init;
    </script>
</body>
</html>
